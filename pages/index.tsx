import {
  Box,
  FormControl,
  FormLabel,
  Spinner,
  Button,
  Text,
  Flex,
} from '@chakra-ui/react';
import type { MetadataPub } from '@prisma/client';
import axios from 'axios';
import Head from 'next/head';
import { debounce } from '../lib/debounce';
import styles from '../styles/Home.module.css';
import { Autocomplete, Item } from '../components/Autocomplete';
import { useAsyncList } from 'react-stately';
import { useState } from 'react';
import { Search2Icon } from '@chakra-ui/icons';

const OFFSET_VALUE: number = 20;

function Home(): JSX.Element {
  const [offset, setOffset] = useState(0);

  let list = useAsyncList<MetadataPub>({
    async load({ signal, cursor, filterText }) {
      const [debouncedRequest] = debounce(
        async (signal, cursor, filterText) => {
          let res = await axios.get(
            cursor || `/api/search?paperTitle=${filterText}`,
            { signal }
          );

          return res.data;
        },
        500
      );

      let data = await debouncedRequest(signal, cursor, filterText);

      setOffset(offset + OFFSET_VALUE);

      return {
        items: data,
        cursor: `/api/search?paperTitle=${filterText}&offset=${offset}`,
      };
    },
  });

  return (
    <Flex
      display="flex"
      justifyContent="center"
    >
      <Head>
        <title>Prot DB</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <link
          rel="icon"
          href="/favicon.ico"
        />
      </Head>

      <Flex
        minHeight="100vh"
        width="100vw"
        padding="1rem"
        flex={1}
        flexDirection="column"
        justifyContent="top"
        alignItems="center"
      >
        <Autocomplete
          label="Star Wars Character Search"
          items={list.items}
          inputValue={list.filterText}
          onInputChange={list.setFilterText}
          loadingState={list.loadingState}
          onLoadMore={list.loadMore}
          button={
            <Button background="protBlue.400">
              <Search2Icon color="protBlack.100" />
            </Button>
          }
          placeholder="test"
        >
          {(item) => <Item key={item.pmid}>{item.title}</Item>}
        </Autocomplete>
      </Flex>
    </Flex>
  );
}

export default Home;
