import { Box, FormControl, FormLabel, Spinner } from '@chakra-ui/react';
import type { MetadataPub } from '@prisma/client';
import axios from 'axios';
import Head from 'next/head';
import { debounce } from '../lib/debounce';
import styles from '../styles/Home.module.css';
import { Autocomplete, Item } from '../components/Autocomplete';
import { useAsyncList } from 'react-stately';
import { useState } from 'react';
import { Search2Icon } from '@chakra-ui/icons';

const OFFSET_VALUE: number = 20;

function Home(): JSX.Element {
  const [offset, setOffset] = useState(0);

  let list = useAsyncList<MetadataPub>({
    async load({ signal, cursor, filterText }) {
      const [debouncedRequest] = debounce(
        async (signal, cursor, filterText) => {
          let res = await axios.get(
            cursor || `/api/search?paperTitle=${filterText}`,
            { signal }
          );

          return res.data;
        },
        500
      );

      let data = await debouncedRequest(signal, cursor, filterText);

      setOffset(offset + OFFSET_VALUE);

      return {
        items: data,
        cursor: `/api/search?paperTitle=${filterText}&offset=${offset}`,
      };
    },
  });

  return (
    <div className={styles.container}>
      <Head>
        <title>Prot DB</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <link
          rel="icon"
          href="/favicon.ico"
        />
      </Head>

      <main className={styles.main}>
        <Autocomplete
          label="Star Wars Character Search"
          items={list.items}
          inputValue={list.filterText}
          onInputChange={list.setFilterText}
          loadingState={list.loadingState}
          onLoadMore={list.loadMore}
          icon={<Search2Icon color="red" />}
        >
          {(item) => <Item key={item.pmid}>{item.title}</Item>}
        </Autocomplete>
      </main>
    </div>
  );
}

export default Home;
